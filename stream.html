<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IKAZ Live - Stream</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <!-- Token Validation -->
        <div id="tokenValidation" class="token-validation glass-card fade-in">
            <div class="validation-header">
                <span class="validation-icon">‚Äî_‚Äî</span>
                <h2>Validasi Akses</h2>
            </div>
            <form id="validationForm" class="validation-form">
                <div class="input-group">
                    <label for="tokenInput">Token Akses</label>
                    <input type="text" id="tokenInput" class="glass-input" placeholder="Masukkan token..." required>
                </div>
                <div class="input-group">
                    <label for="viewerName">Nama Kamu</label>
                    <input type="text" id="viewerName" class="glass-input" placeholder="Nama untuk chat..." required maxlength="30">
                </div>
                <button type="submit" class="btn-primary btn-full">
                    üëä Tonton Live
                </button>
                <p id="validationError" class="error-text hidden"></p>
            </form>
            <a href="index.html" class="back-link">‚Üê Kembali ke Home</a>
        </div>

        <!-- Stream Player -->
        <div id="streamContainer" class="stream-container hidden">
            <header class="stream-header glass-header fade-in">
                <div class="stream-info">
                    <span class="live-badge heartbeat">üëäüòù LIVE</span>
                    <h1 id="streamTitle">IKAZ Live</h1>
                </div>
                <div class="stream-actions">
                    <span id="connectionStatus" class="connection-status">Menghubungkan...</span>
                    <button class="btn-secondary" onclick="leaveStream()">üö∑ Keluar</button>
                </div>
            </header>

            <main class="stream-main">
                <!-- Video Player -->
                <div class="video-container glass-card">
                    <video id="remoteVideo" autoplay playsinline></video>
                    <div id="videoOverlay" class="video-overlay">
                        <div class="loading-spinner"></div>
                        <p>Menghubungkan ke stream...</p>
                    </div>
                    <div id="videoError" class="video-error hidden shake-bottom">
                        <span class="error-icon">‚ö†Ô∏è</span>
                        <p>Gagal terhubung ke stream</p>
                        <button class="btn-primary" onclick="reconnect()">üîÑ Coba Lagi</button>
                    </div>
                </div>

                <!-- Complaint Form -->
                <div class="complaint-container glass-card fade-in">
                    <div class="complaint-header">
                        <h3>üì© Kirim Pengaduan</h3>
                    </div>
                    <div class="complaint-form">
                        <textarea id="complaintMessage" class="glass-input" placeholder="Tulis pengaduan atau pertanyaan..." rows="3" maxlength="500"></textarea>
                        <button class="btn-primary" onclick="sendComplaint()">
                            üì§ Kirim
                        </button>
                    </div>
                    <div id="complaintList" class="my-complaints">
                        <h4>Pengaduan Terkirim</h4>
                        <div id="myComplaintsList"></div>
                    </div>
                </div>
            </main>

            <!-- Notifications Panel -->
            <div class="notifications-panel glass-card fade-in">
                <div class="notif-header">
                    <h3>üîî Notifikasi</h3>
                </div>
                <div id="notificationsList" class="notif-list"></div>
            </div>
        </div>

        <!-- Stream Offline -->
        <div id="streamOffline" class="stream-offline glass-card hidden fade-in">
            <div class="offline-content">
                <span class="offline-icon">üí≠</span>
                <h2>Live Streaming Berakhir</h2>
                <p>Terima kasih sudah menonton!</p>
                <a href="index.html" class="btn-primary">‚Üê Kembali ke Home</a>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-analytics.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc,
            updateDoc,
            deleteDoc,
            addDoc,
            collection, 
            query, 
            where, 
            getDocs,
            onSnapshot,
            orderBy,
            serverTimestamp,
            Timestamp
        } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyABI8SWMoN_4YAtZa5hARAfYcMZ0jHfz1s",
            authDomain: "ikazlive.firebaseapp.com",
            projectId: "ikazlive",
            storageBucket: "ikazlive.firebasestorage.app",
            messagingSenderId: "1026492663745",
            appId: "1:1026492663745:web:41af1ff5662e9411481140",
            measurementId: "G-Y7SW5E6P1V"
        };

        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);

        // WebRTC Configuration
        const rtcConfig = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' }
            ]
        };

        let peerConnection = null;
        let viewerId = null;
        let viewerName = '';
        let complaintTimers = [];
        let unsubscribers = [];

        // Check stored token
        document.addEventListener('DOMContentLoaded', () => {
            const storedToken = sessionStorage.getItem('accessToken');
            if (storedToken) {
                document.getElementById('tokenInput').value = storedToken;
            }
        });

        // Validation form submit
        document.getElementById('validationForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const token = document.getElementById('tokenInput').value.trim();
            const name = document.getElementById('viewerName').value.trim();
            const errorEl = document.getElementById('validationError');
            
            if (!token || !name) {
                showValidationError('Lengkapi semua field');
                return;
            }
            
            try {
                // Validate token
                const tokensRef = collection(db, 'tokens');
                const q = query(tokensRef, where('token', '==', token));
                const snapshot = await getDocs(q);
                
                if (snapshot.empty) {
                    showValidationError('Token tidak valid');
                    return;
                }
                
                const tokenData = snapshot.docs[0].data();
                const now = Timestamp.now();
                
                if (tokenData.expiresAt && tokenData.expiresAt.toMillis() < now.toMillis()) {
                    showValidationError('Token sudah kadaluarsa');
                    return;
                }
                
                // Check if live is online
                const liveRef = doc(db, 'liveStream', 'current');
                const liveSnap = await getDoc(liveRef);
                
                if (!liveSnap.exists() || liveSnap.data().status !== 'online') {
                    showValidationError('Stream sedang tidak aktif');
                    return;
                }
                
                // Store token
                sessionStorage.setItem('accessToken', token);
                viewerName = name;
                
                // Start watching
                startWatching(liveSnap.data());
                
            } catch (error) {
                console.error('Validation error:', error);
                showValidationError('Terjadi kesalahan');
            }
        });

        function showValidationError(message) {
            const errorEl = document.getElementById('validationError');
            const form = document.getElementById('tokenValidation');
            
            errorEl.textContent = message;
            errorEl.classList.remove('hidden');
            
            form.classList.add('shake-horizontal');
            setTimeout(() => {
                form.classList.remove('shake-horizontal');
            }, 500);
        }

        // Start watching stream
        async function startWatching(liveData) {
            // Hide validation, show stream
            document.getElementById('tokenValidation').classList.add('hidden');
            document.getElementById('streamContainer').classList.remove('hidden');
            document.getElementById('streamTitle').textContent = liveData.title || 'IKAZ Live';
            
            // Generate viewer ID
            viewerId = 'viewer_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            // Register as viewer
            await setDoc(doc(db, 'viewers', viewerId), {
                name: viewerName,
                status: 'pending',
                createdAt: serverTimestamp()
            });
            
            // Listen for offer from admin
            listenForOffer();
            
            // Listen to stream status
            listenToStreamStatus();
            
            // Listen to notifications
            listenToNotifications();
            
            // Load my complaints
            loadMyComplaints();
        }

        // Listen for offer from admin
        function listenForOffer() {
            const viewerRef = doc(db, 'viewers', viewerId);
            
            const unsubscribe = onSnapshot(viewerRef, async (docSnap) => {
                if (!docSnap.exists()) {
                    // Viewer was disconnected by admin
                    leaveStream();
                    return;
                }
                
                const data = docSnap.data();
                
                if (data.offer && !peerConnection) {
                    await handleOffer(data.offer);
                }
            });
            
            unsubscribers.push(unsubscribe);
        }

        // Handle incoming offer
        async function handleOffer(offer) {
            try {
                updateConnectionStatus('Menerima offer...');
                
                peerConnection = new RTCPeerConnection(rtcConfig);
                
                // Handle incoming track
                peerConnection.ontrack = (event) => {
                    console.log('Track received:', event.streams);
                    const video = document.getElementById('remoteVideo');
                    video.srcObject = event.streams[0];
                    
                    // Hide overlay, show video
                    document.getElementById('videoOverlay').classList.add('hidden');
                    video.classList.add('fade-in-fwd');
                    updateConnectionStatus('Terhubung ‚úì');
                };
                
                // ICE candidate handling
                peerConnection.onicecandidate = async (event) => {
                    if (event.candidate) {
                        await addDoc(collection(db, 'viewers', viewerId, 'viewerCandidates'), {
                            candidate: event.candidate.toJSON(),
                            createdAt: serverTimestamp()
                        });
                    }
                };
                
                // Connection state change
                peerConnection.onconnectionstatechange = () => {
                    const state = peerConnection.connectionState;
                    console.log('Connection state:', state);
                    
                    if (state === 'connected') {
                        updateConnectionStatus('Terhubung ‚úì');
                    } else if (state === 'disconnected' || state === 'failed') {
                        showVideoError();
                    }
                };
                
                // ICE connection state
                peerConnection.oniceconnectionstatechange = () => {
                    console.log('ICE state:', peerConnection.iceConnectionState);
                };
                
                // Set remote description (offer)
                updateConnectionStatus('Memproses offer...');
                await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
                
                // Listen for admin ICE candidates
                const candidatesUnsub = onSnapshot(
                    collection(db, 'viewers', viewerId, 'adminCandidates'),
                    (snapshot) => {
                        snapshot.docChanges().forEach(async (change) => {
                            if (change.type === 'added') {
                                const data = change.doc.data();
                                try {
                                    await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
                                } catch (e) {
                                    console.error('Error adding ICE candidate:', e);
                                }
                            }
                        });
                    }
                );
                unsubscribers.push(candidatesUnsub);
                
                // Create answer
                updateConnectionStatus('Membuat answer...');
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                
                // Save answer to Firestore
                await updateDoc(doc(db, 'viewers', viewerId), {
                    answer: {
                        type: answer.type,
                        sdp: answer.sdp
                    },
                    status: 'answered'
                });
                
                updateConnectionStatus('Menunggu koneksi...');
                
            } catch (error) {
                console.error('Error handling offer:', error);
                showVideoError();
            }
        }

        function updateConnectionStatus(text) {
            document.getElementById('connectionStatus').textContent = text;
        }

        function showVideoError() {
            document.getElementById('videoOverlay').classList.add('hidden');
            document.getElementById('videoError').classList.remove('hidden');
        }

        // Reconnect
        window.reconnect = async function() {
            document.getElementById('videoError').classList.add('hidden');
            document.getElementById('videoOverlay').classList.remove('hidden');
            
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            
            // Re-register as viewer
            await updateDoc(doc(db, 'viewers', viewerId), {
                status: 'pending',
                offer: null,
                answer: null
            });
        };

        // Listen to stream status
        function listenToStreamStatus() {
            const liveRef = doc(db, 'liveStream', 'current');
            
            const unsubscribe = onSnapshot(liveRef, (docSnap) => {
                if (!docSnap.exists() || docSnap.data().status !== 'online') {
                    // Stream ended
                    showStreamEnded();
                }
            });
            
            unsubscribers.push(unsubscribe);
        }

        function showStreamEnded() {
            document.getElementById('streamContainer').classList.add('hidden');
            document.getElementById('streamOffline').classList.remove('hidden');
            
            // Cleanup
            cleanup();
        }

        // Leave stream
        window.leaveStream = async function() {
            try {
                if (viewerId) {
                    await deleteDoc(doc(db, 'viewers', viewerId));
                }
            } catch (error) {
                console.error('Error leaving stream:', error);
            }
            
            cleanup();
            window.location.href = 'index.html';
        };

        // Cleanup
        function cleanup() {
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            
            unsubscribers.forEach(unsub => unsub());
            unsubscribers = [];
            
            complaintTimers.forEach(timer => clearTimeout(timer));
            complaintTimers = [];
        }

        // Listen to notifications
        function listenToNotifications() {
            const notifRef = collection(db, 'notifications');
            const q = query(notifRef, orderBy('createdAt', 'desc'));
            
            const unsubscribe = onSnapshot(q, (snapshot) => {
                const notifList = document.getElementById('notificationsList');
                notifList.innerHTML = '';
                
                snapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    const time = data.createdAt?.toDate?.() || new Date();
                    const timeStr = time.toLocaleTimeString('id-ID');
                    
                    const notifItem = document.createElement('div');
                    notifItem.className = 'notif-item glass-bubble slide-in-right';
                    notifItem.innerHTML = `
                        <span class="notif-icon">üì¢</span>
                        <p>${data.message}</p>
                        <span class="notif-time">${timeStr}</span>
                    `;
                    notifList.appendChild(notifItem);
                });
            });
            
            unsubscribers.push(unsubscribe);
        }

        // Send complaint
        window.sendComplaint = async function() {
            const message = document.getElementById('complaintMessage').value.trim();
            
            if (!message) {
                alert('Tulis pengaduan terlebih dahulu');
                return;
            }
            
            try {
                const complaintRef = await addDoc(collection(db, 'complaints'), {
                    viewerId: viewerId,
                    viewerName: viewerName,
                    message: message,
                    createdAt: serverTimestamp()
                });
                
                document.getElementById('complaintMessage').value = '';
                
                // Set 5 minute auto-delete timer
                const timer = setTimeout(async () => {
                    try {
                        await deleteDoc(doc(db, 'complaints', complaintRef.id));
                    } catch (e) {
                        console.log('Complaint already deleted');
                    }
                }, 5 * 60 * 1000); // 5 minutes
                
                complaintTimers.push(timer);
                
            } catch (error) {
                console.error('Error sending complaint:', error);
                alert('Gagal mengirim pengaduan');
            }
        };

        // Load my complaints
        function loadMyComplaints() {
            const complaintsRef = collection(db, 'complaints');
            const q = query(complaintsRef, where('viewerId', '==', viewerId), orderBy('createdAt', 'desc'));
            
            const unsubscribe = onSnapshot(q, (snapshot) => {
                const list = document.getElementById('myComplaintsList');
                list.innerHTML = '';
                
                if (snapshot.empty) {
                    list.innerHTML = '<p class="no-complaints-text">Belum ada pengaduan</p>';
                    return;
                }
                
                snapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    const time = data.createdAt?.toDate?.() || new Date();
                    const timeStr = time.toLocaleTimeString('id-ID');
                    
                    const item = document.createElement('div');
                    item.className = 'my-complaint-item glass-bubble slide-in-right';
                    item.innerHTML = `
                        <div class="complaint-content">
                            <p>${data.message}</p>
                            <span class="complaint-time">${timeStr}</span>
                        </div>
                        ${data.reply ? `
                            <div class="complaint-reply">
                                <span class="reply-icon">‚Ü™Ô∏è</span>
                                <p>${data.reply}</p>
                            </div>
                        ` : ''}
                    `;
                    list.appendChild(item);
                });
            });
            
            unsubscribers.push(unsubscribe);
        }

        // Handle page unload
        window.addEventListener('beforeunload', () => {
            if (viewerId) {
                // Use sendBeacon for reliable cleanup
                navigator.sendBeacon && navigator.sendBeacon('about:blank');
            }
        });
    </script>
</body>
</html>