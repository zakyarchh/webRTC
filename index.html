<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IKAZ Live - Home</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container fade-in">
        <!-- Header -->
        <header class="glass-header">
            <div class="logo">
                <span class="logo-icon">üòúü§ô</span>
                <h1>IKAZ Live</h1>
            </div>
            <div id="liveIndicator" class="live-indicator offline">
                <span class="dot"></span>
                <span class="status-text">BELUM LIVE</span>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Live Status Card -->
            <section class="glass-card scale-in-center" id="liveCard">
                <div class="card-header">
                    <h2>üé¨ Status Live</h2>
                </div>
                <div class="card-body">
                    <div id="liveStatus" class="status-display">
                        <div class="status-icon offline-icon">üí≠</div>
                        <p>Sedang tidak ada siaran</p>
                    </div>
                    <div id="liveInfo" class="live-info hidden">
                        <p class="live-title"></p>
                        <button id="watchBtn" class="btn-primary hidden" onclick="goToStream()">
                            üëäTonton Sekarang
                        </button>
                    </div>
                </div>
            </section>

            <!-- Schedule Card -->
            <section class="glass-card scale-in-center delay-1" id="scheduleCard">
                <div class="card-header">
                    <h2>üìÖ Jadwal Live</h2>
                </div>
                <div class="card-body">
                    <div id="scheduleList" class="schedule-list">
                        <div class="schedule-item">
                            <span class="schedule-date">Memuat jadwal...</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Replay Card (Locked) -->
            <section class="glass-card scale-in-center delay-2" id="replayCard">
                <div class="card-header">
                    <h2>üëäüòú Replay</h2>
                </div>
                <div class="card-body">
                    <div class="locked-content" id="lockedReplay">
                        <div class="lock-icon">IZINNNü´∏</div>
                        <p>Masukkan token untuk membuka akses</p>
                    </div>
                    <div class="replay-list hidden" id="replayList">
                        <div class="replay-item glass-bubble">
                            <span>üìπ Replay tidak tersedia</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Token Input Card -->
            <section class="glass-card scale-in-center delay-3" id="tokenCard">
                <div class="card-header">
                    <h2>üé´ Akses Token</h2>
                </div>
                <div class="card-body">
                    <div class="token-form">
                        <input 
                            type="text" 
                            id="tokenInput" 
                            class="glass-input" 
                            placeholder="Masukkan token akses..."
                            maxlength="20"
                        >
                        <button id="validateBtn" class="btn-primary" onclick="validateToken()">
                            ‚úì Validasi
                        </button>
                    </div>
                    <div id="tokenMessage" class="token-message hidden"></div>
                    <div id="validTokenInfo" class="valid-token-info hidden">
                        <p>‚úÖ Token valid! Akses diberikan.</p>
                    </div>
                </div>
            </section>

            <!-- Notifications -->
            <section class="glass-card scale-in-center delay-4" id="notifCard">
                <div class="card-header">
                    <h2>üîî Notifikasi</h2>
                </div>
                <div class="card-body">
                    <div id="notificationList" class="notification-list">
                        <p class="no-notif">Tidak ada notifikasi</p>
                    </div>
                </div>
            </section>
        </main>

        <!-- Footer -->
        <footer class="glass-footer">
            <p>¬© 2026 IKAZ Live ‚Ä¢ Powered by JKT48 üòùü´∏</p>
            <a href="free.html" class="admin-link">free</a>
        </footer>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-analytics.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            collection, 
            query, 
            where, 
            getDocs,
            onSnapshot,
            orderBy,
            limit,
            Timestamp
        } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyABI8SWMoN_4YAtZa5hARAfYcMZ0jHfz1s",
            authDomain: "ikazlive.firebaseapp.com",
            projectId: "ikazlive",
            storageBucket: "ikazlive.firebasestorage.app",
            messagingSenderId: "1026492663745",
            appId: "1:1026492663745:web:41af1ff5662e9411481140",
            measurementId: "G-Y7SW5E6P1V"
        };

        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);

        let isTokenValid = false;
        let validToken = '';

        // Listen to live status
        function listenLiveStatus() {
            const liveRef = doc(db, 'liveStream', 'current');
            
            onSnapshot(liveRef, (docSnap) => {
                const indicator = document.getElementById('liveIndicator');
                const statusDisplay = document.getElementById('liveStatus');
                const liveInfo = document.getElementById('liveInfo');
                const watchBtn = document.getElementById('watchBtn');
                
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    if (data.status === 'online') {
                        indicator.className = 'live-indicator online';
                        indicator.querySelector('.status-text').textContent = 'ONLINE';
                        
                        statusDisplay.innerHTML = `
                            <div class="status-icon online-icon heartbeat">üö•</div>
                            <p>Sedang Live!</p>
                        `;
                        
                        liveInfo.classList.remove('hidden');
                        liveInfo.querySelector('.live-title').textContent = data.title || 'IKAZ Live Streaming';
                        
                        if (isTokenValid) {
                            watchBtn.classList.remove('hidden');
                        }
                    } else {
                        setOfflineStatus();
                    }
                    
                    // Update schedule
                    if (data.schedule) {
                        document.getElementById('scheduleList').innerHTML = `
                            <div class="schedule-item glass-bubble">
                                <span class="schedule-icon">üìÜ</span>
                                <span class="schedule-date">${data.schedule}</span>
                            </div>
                        `;
                    }
                } else {
                    setOfflineStatus();
                }
            });
        }

        function setOfflineStatus() {
            const indicator = document.getElementById('liveIndicator');
            const statusDisplay = document.getElementById('liveStatus');
            const liveInfo = document.getElementById('liveInfo');
            
            indicator.className = 'live-indicator offline';
            indicator.querySelector('.status-text').textContent = 'BELUM LIVE';
            
            statusDisplay.innerHTML = `
                <div class="status-icon offline-icon">üí≠</div>
                <p>Sedang tidak ada siaran</p>
            `;
            
            liveInfo.classList.add('hidden');
        }

        // Listen to notifications
        function listenNotifications() {
            const notifRef = collection(db, 'notifications');
            const q = query(notifRef, orderBy('createdAt', 'desc'), limit(5));
            
            onSnapshot(q, (snapshot) => {
                const notifList = document.getElementById('notificationList');
                
                if (snapshot.empty) {
                    notifList.innerHTML = '<p class="no-notif">Tidak ada notifikasi</p>';
                    return;
                }
                
                notifList.innerHTML = '';
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const time = data.createdAt?.toDate?.() || new Date();
                    const timeStr = time.toLocaleString('id-ID');
                    
                    const notifItem = document.createElement('div');
                    notifItem.className = 'notification-item glass-bubble slide-in-right';
                    notifItem.innerHTML = `
                        <span class="notif-icon">üì¢</span>
                        <div class="notif-content">
                            <p>${data.message}</p>
                            <span class="notif-time">${timeStr}</span>
                        </div>
                    `;
                    notifList.appendChild(notifItem);
                });
            });
        }

        // Validate token
        window.validateToken = async function() {
            const tokenInput = document.getElementById('tokenInput');
            const tokenMessage = document.getElementById('tokenMessage');
            const validTokenInfo = document.getElementById('validTokenInfo');
            const watchBtn = document.getElementById('watchBtn');
            const lockedReplay = document.getElementById('lockedReplay');
            const replayList = document.getElementById('replayList');
            
            const token = tokenInput.value.trim();
            
            if (!token) {
                showTokenError('Masukkan token terlebih dahulu');
                return;
            }
            
            try {
                const tokensRef = collection(db, 'tokens');
                const q = query(tokensRef, where('token', '==', token));
                const snapshot = await getDocs(q);
                
                if (snapshot.empty) {
                    showTokenError('Token tidak valid');
                    return;
                }
                
                const tokenDoc = snapshot.docs[0];
                const tokenData = tokenDoc.data();
                
                // Check expiry
                const now = Timestamp.now();
                if (tokenData.expiresAt && tokenData.expiresAt.toMillis() < now.toMillis()) {
                    showTokenError('Token sudah kadaluarsa');
                    return;
                }
                
                // Token valid
                isTokenValid = true;
                validToken = token;
                
                // Store in sessionStorage
                sessionStorage.setItem('accessToken', token);
                
                tokenMessage.classList.add('hidden');
                validTokenInfo.classList.remove('hidden');
                validTokenInfo.classList.add('fade-in');
                
                // Show watch button if live
                const liveRef = doc(db, 'liveStream', 'current');
                const liveSnap = await getDoc(liveRef);
                if (liveSnap.exists() && liveSnap.data().status === 'online') {
                    watchBtn.classList.remove('hidden');
                }
                
                // Unlock replay section
                lockedReplay.classList.add('hidden');
                replayList.classList.remove('hidden');
                
            } catch (error) {
                console.error('Error validating token:', error);
                showTokenError('Terjadi kesalahan. Coba lagi.');
            }
        };

        function showTokenError(message) {
            const tokenMessage = document.getElementById('tokenMessage');
            const tokenCard = document.getElementById('tokenCard');
            
            tokenMessage.textContent = message;
            tokenMessage.classList.remove('hidden');
            tokenMessage.classList.add('error');
            
            // Add shake animation
            tokenCard.classList.add('shake-horizontal');
            setTimeout(() => {
                tokenCard.classList.remove('shake-horizontal');
            }, 500);
        }

        // Go to stream page
        window.goToStream = function() {
            if (isTokenValid) {
                window.location.href = 'stream.html';
            }
        };

        // Check existing token on load
        async function checkExistingToken() {
            const storedToken = sessionStorage.getItem('accessToken');
            if (storedToken) {
                document.getElementById('tokenInput').value = storedToken;
                await validateToken();
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            listenLiveStatus();
            listenNotifications();
            checkExistingToken();
        });
    </script>
</body>
</html>